# Сеть и доступы

Перед установкой кластера важно подготовить сервер и минимально его защитить.  
Большая часть шагов автоматизирована через **Ansible-роли**, но при необходимости всё можно выполнить вручную.  

---

## Обновления и базовая защита

- обновление всех пакетов и системы безопасности;  
- настройка автоматической установки security-апдейтов;  
- применение параметров ядра через `sysctl`;  
- отключение ненужных сервисов и удаление небезопасных пакетов (telnet, ftp, rsh, finger и т.п.).  

!!! info "Зачем это нужно?"
    Минимизируем поверхность атаки и убираем устаревшие сервисы, которые могут быть использованы для несанкционированного доступа.  

---

## Firewall

Используется **UFW**.  
Базовая настройка включает:

- разрешение доступа по SSH (порт 22/tcp);  
- разрешение внутренних сетей (`internal_network`);  
- открытие только тех портов, которые реально нужны (PostgreSQL, Prometheus, VictoriaMetrics и др.);  
- возможность задать список доверенных IP (`allowed_ips`).  

Пример включения UFW вручную:
```bash
sudo ufw allow ssh
sudo ufw enable
```
!!! tip "Важно"
    Сначала включайте UFW с политикой allow incoming, чтобы не потерять доступ по SSH.
    После настройки правил её можно ужесточить:
    bash sudo ufw default deny incoming

---

## SSH и доступы

- создание резервной копии sshd_config;

- вход только по ключам (парольная аутентификация отключена);

- запрет root-логина паролем;

- при необходимости ограничение входа по IP;

- загрузка ключей в /root/.ssh/authorized_keys;

- возможность включения двухфакторной аутентификации (Google Authenticator).

!!! example "Файлы"
    - Основной конфиг: /etc/ssh/sshd_config
    - Резервная копия: /etc/ssh/sshd_config.backup

---

## Дополнительная защита
- установка и настройка Fail2Ban для защиты от брутфорса;

- конфигурация правил в jail.local;

- опциональная поддержка 2FA через PAM-модуль.

---

## Итог
После применения ролей сервер получает:

- автоматические обновления безопасности;

- минимальный набор работающих сервисов;

- защищённый доступ по SSH-ключам (с поддержкой 2FA при необходимости);

- корректно настроенный firewall;

- Fail2Ban для защиты от brute force-атак.

!!! success "Рекомендация"
    Перед развертыванием убедитесь, что сервер доступен по SSH-ключу и что правила firewall работают так, как планировалось.
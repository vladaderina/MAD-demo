# Установка инфраструктурного ПО

В этом разделе описаны шаги установки всех компонентов инфраструктуры, необходимых для работы кластера и сервисов MAD.  
Все действия автоматизированы через **Ansible-роли**, что позволяет развернуть систему быстро и безопасно.  

---

## Grafana

Для визуализации метрик используется Grafana. Основные шаги установки:

- скачивание deb-пакета Grafana;  
- установка через `apt`;  
- настройка datasources и dashboards через шаблоны Ansible (`datasources.yaml`, `dashboard-postgres.yaml`);  
- запуск сервиса и автозапуск при старте системы;  
- установка пароля администратора;  
- очистка временных файлов.  

!!! tip "Совет"
    После запуска убедитесь, что Grafana доступна по порту, указанному в `grafana_port`.  
    Все dashboards и datasources уже подготовлены для мониторинга PostgreSQL и VictoriaMetrics.

---

## Loki и Promtail

Для сбора логов применяется Loki и его агент Promtail:

- создаются системные пользователи и необходимые директории;  
- скачиваются и распаковываются бинарники Loki и Promtail;  
- создаются конфигурационные файлы через шаблоны Ansible;  
- создаются systemd-сервисы для автоматического запуска и перезапуска;  
- сервисы стартуют автоматически при загрузке системы;  
- временные файлы удаляются после установки.  

!!! tip "Важно"
    Promtail конфигурируется для сбора логов с нужных директорий и отправки их в Loki, который хранит их в формате, пригодном для Grafana.

---

## PostgreSQL

База данных PostgreSQL используется для хранения метаданных и моделей:

- установка версии PostgreSQL, указанной в переменной `postgresql_version`;  
- создание каталога данных с правильными правами доступа;  
- настройка конфигурации (`postgresql.conf`, `pg_hba.conf`) для локального доступа и шифрованной аутентификации;  
- перезапуск сервиса после изменений;  
- установка пароля для пользователя `postgres`.  

!!! tip "Безопасность"
    Используйте надежный пароль, не оставляйте стандартный `change_me_please`.  
    Рекомендуется хранить его в Ansible Vault.

---

## VictoriaMetrics

Для долговременного хранения метрик используется VictoriaMetrics:

- создается системный пользователь;  
- скачивание и распаковка бинарника;  
- создание каталога данных с правильными правами;  
- подготовка systemd-сервиса через шаблон Ansible;  
- запуск и автозапуск сервиса;  
- удаление временных файлов.  

!!! tip "Совет"
    Проверьте, что VictoriaMetrics доступен по порту и директория для данных смонтирована на диске с достаточным объемом.

---

## Резюме

После применения всех ролей сервер получает:

- готовую Grafana с dashboards и источниками данных;  
- работающий стек логирования (Loki + Promtail);  
- PostgreSQL с безопасной конфигурацией и паролем;  
- VictoriaMetrics для хранения временных рядов;  
- автозапуск всех сервисов через systemd;  
- минимизированные временные файлы и чистую структуру каталогов.

!!! success "Рекомендация"
    После завершения установки убедитесь, что все сервисы запущены и работают корректно.  
    Настройте firewall и доступы, чтобы сервер был защищен при подключении к внешним сетям.